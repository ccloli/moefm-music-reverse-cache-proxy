# 萌否电台音频文件反向缓存代理

反向代理请求 `nyan.90g.org` 的真实服务器并缓存存在的音频文件


## 为什么要写这么个东西？

[萌否电台 (`moe.fm`)](http://moe.fm) 是萌否的站长 园长 在 2011 年左右发布的网络电台（或者说更像一个音乐网站，例如某新喵的 [Biu.moe](https://biu.moe)），主要为日系 ACG 类音乐。

萌否电台自 2017 年起就开始间断出现音频服务器 `nyan.90g.org` 无法访问的问题，解析的 IP 也不再是幻电的 CDN。而在 2018 年左右该域名已无法解析到 IP 地址（具体来说是被 CNAME 到了 `moefou.90rg.org` 但是这个域名不存在），此时页面虽然可以正常显示，但是音乐已无法播放。

![](https://user-images.githubusercontent.com/8115912/73596593-4f6ce380-455e-11ea-8d25-c8fb819e82e1.jpg)

大概在 2019 年初听腻了云音乐收藏的歌曲列表， ~~又不敢点开日推担心收藏歌曲暴涨，~~ 于是回想起了之前写的 [第三方萌否电台](https://github.com/ccloli/moefm-html5-project)，怀念起了很久以前收藏的歌曲和 64Kbps 的音质，打算再怀旧一下。

既然萌否的 OAuth API 还能正常工作，只是域名无法解析到对应的 IP，于是接下来就是尝试找到 `nyan.90g.org` 过去的 IP 地址。尝试过使用 `moefou.90g.org` 的 IP，尝试过直接打到 B 站的 CDN IP 上，尝试过找以前的 hosts 文件，尝试过在网上查找这个域名过去的 IP 地址（是的，真的有这样的网站记录 DNS 记录过去的 IP 地址，当然不完整是必然了）……后来不知道怎么的还真给找到了，本地改 hosts 成功播放。

不过考虑到当时下线服务器有可能是因为无法扛住那么大流量（其实稳定性确实有一点差，即便是相当于只有自己一个人用），也有可能是流量费用过大，所以考虑写一个反向代理服务器缓存播放的音频文件，如果命中缓存就不会请求源服务器，这便是这个服务器的由来。


## 如何使用？

```sh
node .
```

服务器默认会在 `127.0.0.1:2333` 启动，此时访问 `http://127.0.0.1:2333` 就会访问萌否电台音频文件的真实服务器，如果文件存在脚本会将文件存储在当前路径下。

此外你也可以直接使用已经部署的线上服务器 `http://nyancdn.moefm.ccloli.com` 访问，不过该服务器因为是四级子域名，所以不能使用 CloudFlare 的 https 加密。

例如萌否电台经常会随机到的《来自NTR的明天》片尾曲《アクアテラリウム》的音频文件的 URL 是 `http://nyan.90g.org/4/1/2d/be484ca4b93d84af414cb0b9b71deff8_320.mp3`，其对应该服务器的反向代理 URL 是 `http://nyancdn.moefm.ccloli.com/4/1/2d/be484ca4b93d84af414cb0b9b71deff8_320.mp3`。

理论上脚本也可以作为其他服务器的反向请求工具，只不过这个脚本一开始只是自用为目的，要这么做就需要硬改代码了。


## 如何确定缓存生效？

服务器会添加 `X-Cache` 响应头，其值即为缓存状态：

- 若文件未被缓存，其值为 `MISS from ccloli.is.a.lolicon.cc`，此时会请求源服务器获取文件输出给用户并缓存
- 若文件已被缓存，其值为 `HIT from ccloli.is.a.lolicon.cc`，此时会直接从缓存中读取文件，不再请求源服务器
- 若文件正在被缓存，其值为 `CACHING from ccloli.is.a.lolicon.cc`，此时会将正在接收的数据克隆并 pipe 给用户

此外你也可以从输出的 log 判断状态，如下是输出 log 示例：

```
2019-02-18T07:10:36.632Z 127.0.0.1[103.126.92.*] - /e/6/57/c6d3aab94862090b6517708c2bdea56f.mp3
HIT e/6/57/c6d3aab94862090b6517708c2bdea56f.mp3
2019-02-18T07:15:48.456Z 127.0.0.1[103.126.92.*] - /b/9/f3/f4b3adc17113594eddde908dbe2e96e4_320.mp3
MISS b/9/f3/f4b3adc17113594eddde908dbe2e96e4_320.mp3
2019-02-18T07:18:10.868Z 127.0.0.1[103.126.92.*] - /c/f/7b/9c11f7c14ae8cf321e3bf1f97178ca3b.mp3
MISS c/f/7b/9c11f7c14ae8cf321e3bf1f97178ca3b.mp3
2019-02-18T07:19:33.700Z 127.0.0.1[103.126.92.*] - /b/9/f3/f4b3adc17113594eddde908dbe2e96e4_320.mp3
CACHING b/9/f3/f4b3adc17113594eddde908dbe2e96e4_320.mp3
Range: bytes=129782-10168945
2019-02-18T07:21:34.996Z 127.0.0.1[103.126.92.*] - /4/5/40/be834640d8400fde492bcad191359ff2_320.mp3
HIT 4/5/40/be834640d8400fde492bcad191359ff2_320.mp3
2019-02-18T07:22:05.723Z 127.0.0.1[103.126.92.*] - /b/9/f3/f4b3adc17113594eddde908dbe2e96e4_320.mp3
CACHING b/9/f3/f4b3adc17113594eddde908dbe2e96e4_320.mp3
Range: bytes=129782-10168945
2019-02-18T07:22:30.862Z 127.0.0.1[103.126.92.*] - /c/f/7b/9c11f7c14ae8cf321e3bf1f97178ca3b.mp3
CACHING c/f/7b/9c11f7c14ae8cf321e3bf1f97178ca3b.mp3
Range: bytes=162550-1866623
2019-02-18T07:47:16.222Z 127.0.0.1[103.126.92.*] - /4/0/39/d9b2b7aab3d3a7e889e382954bc14a67.mp3
MISS 4/0/39/d9b2b7aab3d3a7e889e382954bc14a67.mp3
2019-02-18T07:47:39.831Z 127.0.0.1[103.126.92.*] - /5/7/02/64b241c342df6151bbf7ebabebc743f1.mp3
CACHING 5/7/02/64b241c342df6151bbf7ebabebc743f1.mp3
Range: bytes=98304-
2019-02-18T07:49:15.660Z 127.0.0.1[103.126.92.*] - /4/0/39/d9b2b7aab3d3a7e889e382954bc14a67.mp3
CACHING 4/0/39/d9b2b7aab3d3a7e889e382954bc14a67.mp3
5/7/02/64b241c342df6151bbf7ebabebc743f1.mp3 file size mismatch, dropped
4/0/39/d9b2b7aab3d3a7e889e382954bc14a67.mp3 file size mismatch, dropped
2019-02-18T07:52:25.482Z 127.0.0.1[103.126.92.*] - /4/0/39/d9b2b7aab3d3a7e889e382954bc14a67.mp3
MISS 4/0/39/d9b2b7aab3d3a7e889e382954bc14a67.mp3
2019-02-19T03:01:58.778Z 127.0.0.1[103.126.92.*] - /6/7/7a/2e6b80b9da4444a9225335c18e2a9ecc_320.mp3
MISS 6/7/7a/2e6b80b9da4444a9225335c18e2a9ecc_320.mp3
2019-02-19T03:04:17.431Z 127.0.0.1[103.126.92.*] - /f/5/c7/5360172dbf1977c8e6bb2a3eeefd1ea1.mp3
HIT f/5/c7/5360172dbf1977c8e6bb2a3eeefd1ea1.mp3
2019-02-19T03:11:17.201Z 127.0.0.1[103.126.92.*] - /0/c/8c/d1585ff09c6b120c0c44eacd683c2052.mp3
HIT 0/c/8c/d1585ff09c6b120c0c44eacd683c2052.mp3
If-Modified-Since: Mon, 18 Nov 2013 08:21:00 GMT -> 304 Not Modified
2019-02-19T03:14:34.587Z 127.0.0.1[103.126.92.*] - /4/b/98/5cd408467d7d64cc0a31e68e9fe27839.mp3
MISS 4/b/98/5cd408467d7d64cc0a31e68e9fe27839.mp3
......
2019-04-30T11:04:11.506Z 127.0.0.1[103.126.92.*] - /9/8/91/e7800f3e102f891995b0bf167494e245.mp3
HIT 9/8/91/e7800f3e102f891995b0bf167494e245.mp3
2019-04-30T11:09:32.404Z 127.0.0.1[103.126.92.*] - /4/e/b7/9dee31e2d0d578b0657305c97916a15c.mp3
MISS 4/e/b7/9dee31e2d0d578b0657305c97916a15c.mp3
2019-05-04T00:55:57.103Z 127.0.0.1[165.227.105.*] - /
MISS 
2019-05-04T15:11:02.167Z 127.0.0.1[35.153.226.*] - /
MISS 
2019-05-04T21:39:48.475Z 127.0.0.1[2400:cb00:36:1009:0:0:a29e:*] - /
MISS 
2019-05-04T21:39:49.190Z 127.0.0.1[162.158.65.*] - /
MISS 
2019-05-11T06:20:43.086Z 127.0.0.1[169.187.168.*,46.105.99.*] - //xmlrpc.php
MISS /xmlrpc.php
```

## 目前服务器是否还可使用？

理论上只要原先的音频服务器还能正常访问，该服务器就可使用——前提是你需要知道音频文件的 URL。然而萌否电台以及 [萌否主站](http://moefou.org) 已于 2019 年 4 月中下旬关闭，[萌否开放平台](http://open.moefou.org) 的 OAuth API 也一并无法使用，访问对应地址将会跳转到萌否主站。这就意味着除非你有能力获取到想要的音频文件 URL（例如之前使用的第三方软件的本地缓存数据库），否则这个服务器就几乎没有用处，因为你不知道文件的路径。

这也是我没有隐去脚本中源服务器的 IP 地址的原因，毕竟现在已经无法再找到剩下的文件 URL 了，所以即便该服务器不再使用也已经无所谓了（不过如果你有 URL 可以分享的话，欢迎你在 issue 里分享一下）。


## 有获得文件 URL 的方法吗？

自用的代理服务器自 2019 年 1 月上线至 4 月萌否关站期间一共缓存了 2375 个文件，由于音质主要以 64Kbps 为主，所以总文件数还比较小，但是还是有约 8.35GB 的大小。这些文件应该有八九成是本人收藏的歌曲，所以不如说是自己收藏的歌曲列表，不过这些文件都是哈希文件名且保持原先的文件路径，所以可能无法确定歌曲的实际名称。

![](https://ccloli.com/wp-content/uploads/2020/01/BOC1XVD7XVVSJ1KCGDVYH.png)

这些音频文件后续可能会打包上传到网盘上并更新在下方，以防真的有像我这样的回忆党。

以下是上传至网盘的下载链接：

- [百度网盘](https://pan.baidu.com/s/1VwyEZT9K36bA-6NJM2hTOQ#4f5f)（密码：4f5f）
- [OneDrive](https://whueducn-my.sharepoint.com/:f:/g/personal/ccloli_whu_edu_cn/EsVPpKeRhIBAn7uCxWoBy_gB73SuxnOLO7FeElGiHQTZVw?e=PJzxLd)

## 所以已经有那么多音乐平台了，为什么要写这么个东西？

说到底还是为了怀旧，听着过去收藏的音乐以及如今可能算是惨不忍睹的 64Kbps 降采样音乐，感觉就像回到了过去那段时光吧。嗯，正好是记忆力最好的高中，所以也算是记忆深刻吧 = =

大概只是怀念起了某人第一次推荐萌否电台的时候（啊，好像也是最早在博客上留言的人，还是因为 Kcnny(?)），只是怀念起了当时上学无聊时（？）构思如何实现那个第三方的 web 电台的时候（比较夸张的大概是某次考试提前写完试卷后用草稿纸直接写代码 = =），只是怀念起高考前单曲循环的某一首歌的时候（然而那首歌忘了叫什么，云音乐上曾经日推出现时收藏过，可惜估计现在因为迷惑版权原因没了 = =），只是怀念起大学考前复习的时候（即便浏览器会被安卓后台杀死还是听了不少曲子 = =）……总之就是各种怀念 = =

嗯，说到底只是怀念过去而已，音质并不重要，反而这样糟糕的音质更贴合过去那模糊的记忆 = =

大概就如年末总结里说的那样，如果萌否电台还活着，今年常用的音乐工具应该会算它一个的，嗯 = =

萌否电台还是没了，青春也一去不复返了（？），虽然当时关站时还厚着脸皮问了下园长能不能帮忙导出一份收藏数据，当然本身这种事就不太可能嘛 = =

其实萌否的收藏数据导出当时已经在写了，毕竟当时就估计萌否可能哪天就没了，可惜刚开了个头就咕了，然后咕到萌否没了 = =

啊，曾经还在梦里（？）给那个自己实现的第三方 web 电台想了个 UI，然后只是梦到了而已，并没有实现 = =

所以懒癌真要命 = =
